services:
  redis:
    image: valkey/valkey:8
    container_name: ragflow-redis
    environment:
      - TZ=Asia/Seoul
    command: valkey-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 30
    restart: unless-stopped
    networks:
      - ragflow
  ragflow:
    image: infiniflow/ragflow:v0.23.1
    container_name: ragflow
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "127.0.0.1:8080:80"
      - "127.0.0.1:9380:9380"
    volumes:
      - ragflowdata:/ragflow/logs
      - ./nginx/ragflow.conf:/etc/nginx/conf.d/ragflow.conf:ro
      - ./nginx/entrypoint-wrapper.sh:/ragflow/entrypoint-wrapper.sh:ro
      - ./service_conf.yaml.template:/ragflow/conf/service_conf.yaml.template:ro
    entrypoint: ["/bin/bash", "/ragflow/entrypoint-wrapper.sh"]
    environment:
      - DOC_ENGINE=elasticsearch
      - DEVICE=cpu
      # Elasticsearch: NixOS native (br-ragflow gateway)
      - ES_HOST=172.30.0.1
      - ES_PORT=9200
      # MySQL: NixOS native
      - MYSQL_HOST=172.30.0.1
      - MYSQL_PORT=3306
      - MYSQL_DBNAME=rag_flow
      - MYSQL_USER=ragflow
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      # MinIO: NixOS native
      - MINIO_HOST=172.30.0.1
      - MINIO_PORT=9000
      - MINIO_USER=${MINIO_USER}
      - MINIO_PASSWORD=${MINIO_PASSWORD}
      # Redis: Docker container
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - TZ=Asia/Seoul
    extra_hosts:
      - "vllm.sjanglab.org:100.64.0.1" # psi via Headscale
      - "tei.sjanglab.org:100.64.0.1" # psi via Headscale
    restart: unless-stopped
    networks:
      - ragflow
volumes:
  redisdata:
  ragflowdata:
networks:
  ragflow:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-ragflow
    ipam:
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.1
